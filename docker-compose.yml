services:
  # Fix permissions for wakeword_data and configuration volume
  fix-permissions:
    image: "ghcr.io/ohf-voice/linux-voice-assistant:latest"
    entrypoint: []
    command: "chown -R ${LVA_USER_ID}:${LVA_USER_GROUP} /app/local /app/configuration /home/tom"
    env_file: .env
    group_add:
      - audio
    volumes:
      - wakeword_data:/app/local
      - configuration:/app/configuration
      - /home/tom/container_home:/home/tom
    restart: "no"

  # Linux Voice Assistant
  linux-voice-assistant:
    container_name: linux-voice-assistant
    image: "ghcr.io/ohf-voice/linux-voice-assistant:latest"
    restart: unless-stopped
    network_mode: "host"
    user: "${LVA_USER_ID}:${LVA_USER_GROUP}"
    environment:
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      - MPV_AO=pulse
      - MPV_OPTS=--ao=pulse --audio-device=pulse
      - AUDIO_OUTPUT_DEVICE=pulse
      - HOME=/home/tom
    env_file: .env
    group_add:
      - audio
    cap_add:
      - SYS_NICE
    volumes:
      - wakeword_data:/app/local
      - configuration:/app/configuration
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ${LVA_XDG_RUNTIME_DIR}:${LVA_XDG_RUNTIME_DIR}
      - /home/tom/container_home:/home/tom
    depends_on:
      - fix-permissions
    healthcheck:
      test: ["CMD", "pgrep", "-f", "linux_voice_assistant"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

volumes:
  wakeword_data:
  configuration:
